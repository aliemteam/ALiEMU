#!/bin/bash

SCRIPTDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOTDIR=$(cd $SCRIPTDIR && cd ../../ && pwd || exit)
machine_name=aliemu

# shellcheck source=./helpers
source $SCRIPTDIR/helpers || exit 1

depcheck \
    rsync \
    ssh \
    ssh-agent \
    ssh-add \
    ssh-keyscan \
    ssh-keygen

# Compile the code
$ROOTDIR/node_modules/.bin/gulp build

eval "$(ssh-agent -s)" &>/dev/null
ssh-add "$HOME/.ssh/DO_${machine_name}_rsa" &>/dev/null

if [ -z "$(ssh-keygen -F "$(docker-machine ip $machine_name)")" ]; then
  ssh-keyscan -H "$(docker-machine ip $machine_name)" >> ~/.ssh/known_hosts
fi

h2 "Deploying..."
rsync --info=progress2 --chown=www-data:www-data -aOz --no-p -e "ssh -i $HOME/.ssh/DO_${machine_name}_rsa" "$ROOTDIR/dist/" "$(docker-machine ip $machine_name)":/app/dist
h2 "Deploy Finished."
