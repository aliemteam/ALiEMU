#!/bin/bash

SCRIPTDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOTDIR=$(cd $SCRIPTDIR && cd ../../ && pwd || exit)

# shellcheck source=../../.env
source $ROOTDIR/.env

# shellcheck source=./helpers
source $SCRIPTDIR/helpers || exit 1

machine_name=${machine_name:-}
[[ ! $machine_name ]] && ERROR "'machine_name' must be set in your .env file"

depcheck \
    rsync \
    ssh \
    ssh-agent \
    ssh-add \
    ssh-keyscan \
    ssh-keygen

# Compile the code
$ROOTDIR/node_modules/.bin/gulp build

eval "$(ssh-agent -s)" &>/dev/null
ssh-add "$HOME/.ssh/DO_${machine_name}_rsa" &>/dev/null

if [ -z "$(ssh-keygen -F "$(docker-machine ip $machine_name)")" ]; then
  ssh-keyscan -H "$(docker-machine ip $machine_name)" >> ~/.ssh/known_hosts
fi

h2 "Deploying..."
docker-machine ssh $machine_name "chmod -R g+rwx /app"
rsync --info=progress2 --chown=www-data:www-data -aOz --no-p -e "ssh -i $HOME/.ssh/DO_${machine_name}_rsa" "$ROOTDIR/dist/" "$(docker-machine ip $machine_name)":/app/dist
docker-machine ssh $machine_name "chmod -R g+rwx /app"
h2 "Deploy Finished."
